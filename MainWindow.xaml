<Window x:Class="QualisulCameraApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:QualisulCameraApp"
        xmlns:vm="clr-namespace:QualisulCameraApp.ViewModels"
        xmlns:converters="clr-namespace:QualisulCameraApp.Converters"
        mc:Ignorable="d"
        Title="Qualisul Camera App" Height="720" Width="1280"
        Background="#0B131F">
    
    <Window.Resources>
        <converters:BooleanToBrushConverter x:Key="BooleanToBrushConverter"/>
        <converters:BooleanToSessionTextConverter x:Key="BooleanToSessionTextConverter"/>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
        
        <Style x:Key="RoundButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#3399FF"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="4"/>
            <Setter Property="BorderBrush" Value="White"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="30">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>



        <!-- Resource Dictionary entries -->
        
        <!-- ToggleButton Template for ComboBox -->
        <ControlTemplate x:Key="ComboBoxToggleButton" TargetType="ToggleButton">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition Width="20" />
                </Grid.ColumnDefinitions>
                <Border x:Name="Border" 
                        Grid.ColumnSpan="2"
                        CornerRadius="4"
                        Background="{TemplateBinding Background}"
                        BorderBrush="{TemplateBinding BorderBrush}"
                        BorderThickness="1" />
                <Border Grid.Column="0"
                        CornerRadius="4,0,0,4" 
                        Margin="1" 
                        Background="Transparent" 
                        BorderBrush="Transparent" 
                        BorderThickness="0,0,1,0" />
                <Path x:Name="Arrow" 
                      Grid.Column="1" 
                      Fill="Orange"
                      HorizontalAlignment="Center" 
                      VerticalAlignment="Center"
                      Data="M0,0 L0,2 L4,6 L8,2 L8,0 L4,4 z" />
            </Grid>
            <ControlTemplate.Triggers>
                <Trigger Property="IsChecked" Value="True">
                   <!-- Keep same look when open -->
                </Trigger>
            </ControlTemplate.Triggers>
        </ControlTemplate>

        <!-- Main ComboBox Style -->
        <Style x:Key="DarkComboBoxStyle" TargetType="{x:Type ComboBox}">
            <Setter Property="Foreground" Value="Orange"/>
            <Setter Property="Background" Value="#1A2639"/>
            <Setter Property="BorderBrush" Value="#334455"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Auto"/>
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="ScrollViewer.CanContentScroll" Value="True"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="6,3,5,3"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ComboBox}">
                        <Grid>
                            <ToggleButton Name="ToggleButton" 
                                          Template="{StaticResource ComboBoxToggleButton}" 
                                          Grid.Column="2" 
                                          Focusable="false"
                                          IsChecked="{Binding Path=IsDropDownOpen,Mode=TwoWay,RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press" 
                                          Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"/>
                            <ContentPresenter Name="ContentSite" 
                                              IsHitTestVisible="False"  
                                              Content="{TemplateBinding SelectionBoxItem}"
                                              ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                              ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                              Margin="10,3,23,3"
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Left" />
                            <Popup Name="Popup"
                                   Placement="Bottom"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   AllowsTransparency="True" 
                                   Focusable="False"
                                   PopupAnimation="Slide">
                                <Grid Name="DropDown"
                                      SnapsToDevicePixels="True"
                                      MinWidth="{TemplateBinding ActualWidth}"
                                      MaxHeight="{TemplateBinding MaxDropDownHeight}">
                                    <Border x:Name="DropDownBorder"
                                            Background="#1A2639"
                                            BorderThickness="1"
                                            BorderBrush="#334455"/>
                                    <ScrollViewer Margin="4,6,4,6" SnapsToDevicePixels="True">
                                        <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Contained" />
                                    </ScrollViewer>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Setter Property="ItemContainerStyle">
                 <Setter.Value>
                    <Style TargetType="{x:Type ComboBoxItem}">
                        <Setter Property="SnapsToDevicePixels" Value="True"/>
                        <Setter Property="OverridesDefaultStyle" Value="True"/>
                         <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="{x:Type ComboBoxItem}">
                                    <Border Name="Border" Padding="4,2" SnapsToDevicePixels="true" Background="Transparent">
                                        <ContentPresenter />
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsHighlighted" Value="true">
                                            <Setter TargetName="Border" Property="Background" Value="#334455"/>
                                        </Trigger>
                                        <Trigger Property="IsSelected" Value="true">
                                            <Setter TargetName="Border" Property="Background" Value="#334455"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Foreground" Value="Orange"/>
                        <Setter Property="Background" Value="Transparent"/>
                    </Style>
                </Setter.Value> 
            </Setter>
        </Style>
    </Window.Resources>

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="20" Orientation="Horizontal">
            <TextBlock Text="QUALISUL" Foreground="#FF9900" FontSize="24" FontWeight="Bold"/>
            <TextBlock Text=" METROLOGIA" Foreground="#AAAAAA" FontSize="14" VerticalAlignment="Center" Margin="5,4,0,0"/>
        </StackPanel>

        <!-- Content -->
        <Grid Grid.Row="1" Margin="20,0,20,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/> <!-- Controls -->
                <ColumnDefinition Width="*"/>   <!-- Camera & Gallery -->
            </Grid.ColumnDefinitions>

            <!-- Left Controls -->
            <StackPanel Grid.Column="0" Margin="0,0,20,0">
                <!-- Camera Selection -->
                <Border BorderBrush="#334455" BorderThickness="1" CornerRadius="8" Padding="15" Margin="0,0,0,20" Background="#111B29">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                             <TextBlock Text="&#xE722;" FontFamily="Segoe MDL2 Assets" Foreground="#3399FF" FontSize="20" VerticalAlignment="Center"/>
                             <TextBlock Text="Selecionar Câmera:" Foreground="#CCCCCC" Margin="10,0,0,0" VerticalAlignment="Center"/>
                             <Button Command="{Binding RefreshCamerasCommand}" Background="Transparent" BorderThickness="0" Margin="10,0,0,0" ToolTip="Atualizar Câmeras" Cursor="Hand">
                                 <TextBlock Text="&#xE72C;" FontFamily="Segoe MDL2 Assets" Foreground="#3399FF" FontSize="16"/>
                             </Button>
                        </StackPanel>
                        <ComboBox ItemsSource="{Binding AvailableCameras}" SelectedItem="{Binding SelectedCamera}" 
                                  Height="40" Style="{StaticResource DarkComboBoxStyle}">
                        </ComboBox>
                    </StackPanel>
                </Border>

                <!-- Client Folder & OS -->
                <Border BorderBrush="#334455" BorderThickness="1" CornerRadius="8" Padding="15" Margin="0,0,0,20" Background="#111B29">
                    <StackPanel>
                        <TextBlock Text="Cliente (Pasta de Destino):" Foreground="#888888" Margin="0,0,0,5"/>
                        <Grid Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding ClientPath}" IsReadOnly="True" 
                                     Background="#1A2639" Foreground="#AAAAAA" BorderBrush="#334455" Height="35" VerticalContentAlignment="Center" Padding="5,0"/>
                            <Button Grid.Column="1" Command="{Binding SelectClientFolderCommand}" Content="Cliente" Margin="10,0,0,0" Height="35" Width="100" Background="#334455" Foreground="White" BorderThickness="0"/>
                        </Grid>

                        <TextBlock Text="Continuar OS Existente:" Foreground="#888888" Margin="0,0,0,5"/>
                         <ComboBox ItemsSource="{Binding ExistingSessions}" SelectedItem="{Binding SelectedExistingSession}" 
                                  Height="35" Style="{StaticResource DarkComboBoxStyle}" Margin="0,0,0,15">
                        </ComboBox>

                        <TextBlock Text="Ordem de Serviço (OS):" Foreground="#888888" Margin="0,0,0,5"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding OSNumber}" 
                                     Background="#1A2639" Foreground="White" BorderBrush="#334455" Height="35" VerticalContentAlignment="Center" Padding="5,0"/>
                            <Button Grid.Column="1" Command="{Binding GenerateFolderCommand}" Content="Criar" Margin="10,0,0,0" Height="35" Background="#334455" Foreground="White" BorderThickness="0" Width="100"/>
                        </Grid>

                        <TextBlock Text="Renomear OS (Ao Encerrar):" Foreground="#888888" Margin="0,10,0,5"/>
                        <TextBox Text="{Binding RenameOSText}" 
                                 Background="#1A2639" Foreground="White" BorderBrush="#334455" Height="35" VerticalContentAlignment="Center" Padding="5,0"
                                 ToolTip="Preencha apenas se desejar renomear a pasta ao encerrar (Somente novas sessões)."/>
                    </StackPanel>
                </Border>

                <!-- Session Button -->
                <Button Command="{Binding ToggleSessionCommand}" Height="50" FontSize="16" FontWeight="Bold"
                        Background="{Binding IsSessionActive, Converter={StaticResource BooleanToBrushConverter}}" 
                        Foreground="White" Cursor="Hand" BorderThickness="0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#xE768;" FontFamily="Segoe MDL2 Assets" Margin="0,0,10,0" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding IsSessionActive, Converter={StaticResource BooleanToSessionTextConverter}}" VerticalAlignment="Center"/> 
                    </StackPanel>
                </Button>
                
                <!-- Help Button -->
                <Button Command="{Binding OpenHelpCommand}" Width="50" Height="50" HorizontalAlignment="Left" Margin="0,20,0,0"
                        Background="#0088CC" BorderThickness="0" Cursor="Hand" ToolTip="Procedimento de Fotos">
                     <TextBlock Text="?" FontSize="24" FontWeight="Bold" Foreground="White"/>
                     <Button.Template>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                     </Button.Template>
                </Button>
            </StackPanel>

            <!-- Right Camera & Gallery -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>   <!-- Viewfinder -->
                    <RowDefinition Height="220"/> <!-- Gallery -->
                </Grid.RowDefinitions>

                <!-- Viewfinder -->
                <Border Grid.Row="0" Margin="0,0,0,20" Background="Black" CornerRadius="8" ClipToBounds="True">
                    <Grid>
                        <!-- Camera Image -->
                        <Image Source="{Binding CameraFeed}" Stretch="Uniform"/>
                        
                        <!-- Grid Overlay (Optional visual) -->
                        <Grid Opacity="0.3">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <Border Grid.Column="0" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0,0,1,0"/>
                            <Border Grid.Column="1" Grid.RowSpan="3" BorderBrush="Gray" BorderThickness="0,0,1,0"/>
                            <Border Grid.Row="0" Grid.ColumnSpan="3" BorderBrush="Gray" BorderThickness="0,0,0,1"/>
                            <Border Grid.Row="1" Grid.ColumnSpan="3" BorderBrush="Gray" BorderThickness="0,0,0,1"/>
                        </Grid>

                        <!-- Capture Button Overlay -->
                        <Button Command="{Binding CapturePhotoCommand}" HorizontalAlignment="Center" VerticalAlignment="Bottom" Margin="0,0,0,20"
                                Width="60" Height="60" Style="{StaticResource RoundButtonStyle}"
                                IsEnabled="{Binding IsSessionActive}">
                             <TextBlock Text="&#xE722;" FontFamily="Segoe MDL2 Assets" Foreground="White" FontSize="24" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                        </Button>
                    </Grid>
                </Border>

                <!-- Gallery -->
                <Border Grid.Row="1" BorderBrush="#334455" BorderThickness="1" CornerRadius="8" Background="#111B29">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Gallery Header -->
                        <Grid Grid.Row="0" Margin="15">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE8B9;" FontFamily="Segoe MDL2 Assets" Foreground="#3399FF" FontSize="20" VerticalAlignment="Center"/>
                                <TextBlock Text="Galeria da Sessão" Foreground="White" Margin="10,0,0,0" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding GalleryPhotos.Count, StringFormat='(Total: {0} fotos)'}" Foreground="#777777" Margin="5,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <!-- TAG Input -->
                            <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" Width="200">
                                <TextBlock Text="&#xE8EC;" FontFamily="Segoe MDL2 Assets" Foreground="#3399FF" Margin="0,0,5,0" VerticalAlignment="Center" FontSize="16"/>
                                <TextBox Text="{Binding TagText}" Width="150" Background="#1A2639" Foreground="White" BorderBrush="#334455"
                                         VerticalContentAlignment="Center" Padding="5"/>
                            </StackPanel>
                        </Grid>

                        <!-- Gallery Items -->
                        <ListBox Grid.Row="1" ItemsSource="{Binding GalleryPhotos}" Background="Transparent" BorderThickness="0" 
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Auto">
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="5" CornerRadius="4" BorderBrush="#334455" BorderThickness="1" Width="140" Height="140">
                                        <Grid>
                                            <Image Source="{Binding Image}" Stretch="UniformToFill"/>
                                            <!-- Delete Button Overlay -->
                                            <Button Command="{Binding DataContext.DeletePhotoCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                    CommandParameter="{Binding}"
                                                    HorizontalAlignment="Right" VerticalAlignment="Top" Margin="5"
                                                    Width="25" Height="25" Background="#88FF0000" BorderThickness="0" Cursor="Hand" Style="{StaticResource RoundButtonStyle}">
                                                <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets" Foreground="White" FontSize="12"/>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        
                        <!-- Empty State -->
                        <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                    Visibility="{Binding GalleryPhotos.Count, Converter={StaticResource CountToVisibilityConverter}}">
                            <TextBlock Text="&#xE722;" FontFamily="Segoe MDL2 Assets" Foreground="#334455" FontSize="40" HorizontalAlignment="Center"/>
                            <TextBlock Text="As fotos capturadas aparecerão aqui" Foreground="#334455" Margin="0,10,0,0"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Window>
